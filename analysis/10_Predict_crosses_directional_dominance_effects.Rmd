---
title: "10_Predict_crosses_directional_dominance_effects"
author: "Paulo-HR"
date: "2023-10-31"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

#################
#
## Introduction
#
################
```{r}
library(genomicMateSelectR)
library(data.table)
```

############################
#
## Load inputs and set-up
#
############################

###############################
#
## Genomic relationship matrix
#
###############################
```{r}
## Dominance relationship matrix
D<-readRDS(file=here::here("output","kinship_dom.rds"))
D<-D[order(rownames(D)),order(rownames(D))]
dim(D)

## Additive relationship matrix
A<-readRDS(file=here::here("output","kinship_add.rds"))
A<-A[order(rownames(A)),order(rownames(A))]
dim(A)
```

##########
#
## Blups
#
##########
```{r}
blups<-readRDS(here::here("output","blups_fixed_labels.rds")) %>% 
     # need to rename the "blups" list to comply with the runCrossVal function
     dplyr::rename(TrainingData=blups) %>% 
     dplyr::select(Trait,TrainingData) %>% 
     # need also to remove phenotyped-but-not-genotyped lines
     mutate(TrainingData=map(TrainingData,
                             ~filter(.,germplasmName %in% rownames(A)) %>% 
                                  # rename the germplasmName column to GID
                                  dplyr::rename(GID=germplasmName)))
```


###########################################
#
## Sorting the data frame by germplasmName
#
############################################
```{r}
for(i in 1:nrow(blups)){
blups$TrainingData[[i]] <- blups$TrainingData[[i]][order(blups$TrainingData[[i]]$GID),]
}
blups
```


###################
#
## Dosage matrix
#
###################
```{r}
## Dosages are also needed for runGenomicPredictions() when getMarkEffs=TRUE
## Reason is that they are used to extra SNP effects from GBLUP models
dosages<-readRDS(here::here("data","dosages.rds"))
dosages <- dosages[order(rownames(dosages)), ]
dim(dosages)
```


#######################
#
## Selection indices
#
#######################
```{r}
SIwts<-c(DMCg=5,
         CWLSD=0,
         CBroLS=0,
         CBliLS=0,
         StC=10,
         PA=-8,
         logFRY=10,
         logFSY=8)
SIwts
```

########################################################
#
## Constructing a genomic relationship matrix vector
#
########################################################
```{r}
grms<-list(A=A,D=D)
```

########################
#
## Get marker effects
#
########################
```{r}
gpredsDirDom<-runGenomicPredictions(modelType = "DirDom", 
                               selInd = T, SIwts = SIwts,
                               getMarkEffs = TRUE,
                               dosages = dosages,
                               blups = blups, 
                               grms = list(A=grms[["A"]],
                                           D=grms[["D"]]),
                               ncores=32)
```

#####################
#
## Save the results
#
#####################
```{r}
saveRDS(gpredsDirDom,file = here::here("output","genomicPredictions_directional_dominance.rds"))
```

############################
#
## Reading the results
#
############################
```{r}
gpredsDirDom1<-readRDS(here::here("output","genomicPredictions_directional_dominance.rds"))
```


############################
#
## Visualizing SNP-effects 
#
############################
```{r}
gpredsDirDom1$genomicPredOut[[1]]
gpredsDirDom1$gblups[[1]] %>% head
gpredsDirDom1$genomicPredOut[[1]] %>% dplyr::select(Trait,allelesubsnpeff,addsnpeff,domsnpeff)
```

###################################
#
## Picking the candidate parents
#
###################################
```{r}
# Access the predicted GEBV and GETGV
top1000<-gpredsDirDom1$gblups[[1]] %>% 
# Filter by GETV values
     filter(predOf=="GETGV") %>% 
     # I'll pick 1000 parents
     slice(1:10) %$%
# And extract their GID to a vector
     GID
```

#########################
#
## Crosses-to-predict
#
#########################
```{r}
CrossesToPredict<-crosses2predict(top1000)
```

####################################################################
#
## Data frame indicating what pairs of parents to predict crosses
#
####################################################################
```{r}
CrossesToPredict %>% head
```

##########################################
#
## Number of parents to make predictions
#
##########################################
```{r}
CrossesToPredict %>% nrow()
```

##############################
#
## Run predictCrosses
#
##############################

######################
#
## Haplotype matrix
#
######################
```{r}
## keep only haplos for candidate parents we want to predict crosses for
## those which will be used in prediction, saves memory
haploMat<-readRDS(file=here::here("data","haplotypes.rds"))
parenthaps<-sort(c(paste0(top1000parents,"_HapA"),
                   paste0(top1000parents,"_HapB")))
haploMat<-haploMat[parenthaps,]
```

#####################################
#
## Recombination frequency matrix
#
#####################################
```{r}
recombFreqMat<-readRDS(file=here::here("output","recombFreqMat_1minus2c.rds"))
```


##############################
#
## Predicted Crosses values
#
##############################
```{r}
starttime<-proc.time()[3]
crossPredsDirDom<-predictCrosses(modelType="DirDom",
                           selInd = T, SIwts = SIwts,
                           CrossesToPredict=CrossesToPredict,
                           snpeffs=gpredsDirDom1$genomicPredOut[[1]], 
                           haploMat=haploMat,
                           dosages = dosages[top1000parents,],
                           recombFreqMat=recombFreqMat,
                           ncores=32)
elapsed<-proc.time()[3]-starttime; elapsed/60
```

```{r}
crossPredsDirDom$tidyPreds[[1]] %>% str
```

###################
#
## Crossing plan
#
##################
```{r}
top10crosses<-crossPredsDirDom$tidyPreds[[1]] %>% 
     filter(Trait=="SELIND") %>% 
     dplyr::select(-predVar) %>% 
     arrange(desc(predUsefulness)) %>% 
     slice(1:10)
top10crosses
```

###############################
#
## Pull effect for each trait
#
###############################
```{r}
Ef.crosses1<-crossPredsAD$tidyPreds[[1]] %>% 
     filter(Trait=="DMCg")  
Ef.crosses2<-crossPredsAD$tidyPreds[[1]] %>% 
     filter(Trait=="CWLSD")
Ef.crosses3<-crossPredsAD$tidyPreds[[1]] %>% 
     filter(Trait=="CBroLS")
Ef.crosses4<-crossPredsAD$tidyPreds[[1]] %>% 
     filter(Trait=="CBliLS")
Ef.crosses5<-crossPredsAD$tidyPreds[[1]] %>% 
     filter(Trait=="StC")
Ef.crosses6<-crossPredsAD$tidyPreds[[1]] %>% 
     filter(Trait=="PA")
Ef.crosses7<-crossPredsAD$tidyPreds[[1]] %>% 
     filter(Trait=="logFRY")
Ef.crosses8<-crossPredsAD$tidyPreds[[1]] %>% 
     filter(Trait=="logFSY")
```

###########################
#
## Merging all the traits
#
###########################
```{r}
table(Ef.crosses1$damID == Ef.crosses2$damID)
table(Ef.crosses1$sireID == Ef.crosses2$sireID)
Ef.crosses <- cbind(Ef.crosses1[,c(1,2,9)],Ef.crosses2[,9],Ef.crosses3[,9],Ef.crosses4[,9],Ef.crosses5[,9], Ef.crosses6[,9],Ef.crosses7[,9],Ef.crosses8[,9])
colnames(Ef.crosses)[3:10]<- c("DMCg.UC","CWLSD.UC","CBrolS.UC","CBliLS.UC","StC.UC","PA.UC","logFRY.UC","logFSY.UC")
```

###################
#
## Saving results
#
###################
```{r}
write.table(crossPredsDirDom$tidyPreds[[1]],file = here::here("output","crossPreds_directional_dominance.csv"),sep=",",quote = FALSE)
write.table(Ef.crosses,file = here::here("output","UC_crosses_directional_dominance.csv"),sep=",",quote = FALSE)
```
